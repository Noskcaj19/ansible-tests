---
- name: Verify
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Check Vector binary is installed
      ansible.builtin.stat:
        path: /usr/local/bin/vector
      register: _binary_stat

    - name: Verify binary installation
      ansible.builtin.assert:
        that:
          - _binary_stat.stat.exists
          - _binary_stat.stat.executable
        fail_msg: "Vector binary is not installed at /usr/local/bin/vector"

    - name: Check Vector service is running
      ansible.builtin.systemd:
        name: vector
        state: started
        enabled: true
      check_mode: true
      register: _svc_check

    - name: Verify service status
      ansible.builtin.assert:
        that:
          - not _svc_check.changed
        fail_msg: "Vector service is not running or not enabled"

    - name: Check configuration file exists
      ansible.builtin.stat:
        path: /etc/vector/vector.yaml
      register: _config_stat

    - name: Verify configuration file
      ansible.builtin.assert:
        that:
          - _config_stat.stat.exists
          - _config_stat.stat.isreg
        fail_msg: "Configuration file is missing"

    - name: Validate Vector configuration
      ansible.builtin.command:
        cmd: /usr/local/bin/vector validate /etc/vector/vector.yaml
      register: _validation_result
      changed_when: false

    - name: Verify Vector binary works
      ansible.builtin.command:
        cmd: /usr/local/bin/vector --version
      register: _version_result
      changed_when: false

    - name: Display Vector version
      ansible.builtin.debug:
        msg: "Vector installed: {{ _version_result.stdout }}"
