---
- name: Ensure Vector config directory exists
  ansible.windows.win_file:
    path: "{{ vector_config_dir }}"
    state: directory

- name: Ensure Vector data directory exists
  ansible.windows.win_file:
    path: "{{ vector_data_dir }}"
    state: directory

- name: Deploy Vector configuration (staged)
  ansible.windows.win_template:
    src: vector.yaml.j2
    dest: "{{ vector_config_file }}.new"
  register: vector_config_staged

- name: Deploy staged configuration  # noqa: no-handler
  when: vector_config_staged.changed
  block:
    - name: Validate staged Vector configuration
      ansible.windows.win_command:
        cmd: '"{{ vector_bin_path }}" validate "{{ vector_config_file }}.new"'
      changed_when: false

    - name: Move validated configuration into place
      ansible.windows.win_copy:
        src: "{{ vector_config_file }}.new"
        dest: "{{ vector_config_file }}"
        remote_src: true
      notify: Restart vector

    - name: Remove staged configuration file
      ansible.windows.win_file:
        path: "{{ vector_config_file }}.new"
        state: absent
